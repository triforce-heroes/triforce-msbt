import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import{parseHeader as t}from"./parser/parseHeader.js";import{parseSections as n}from"./parser/parseSections.js";import{hash as r}from"./utils/hash.js";function i(t,n){let r=new e;return r.writeString(t),r.writeUnsignedInt32(n.length),r.pad(16),r.push(n),r.pad(16,"«"),r.build()}export function rebuild(l,s){let g;let o=t(s),d=n(s,o);for(let[e,t]of d.entries())"LBL1"===e&&(g=t.readUInt32LE());let f=new Map(Array.from({length:g},(e,t)=>[t,[]])),u=new e,w=new e,h=4+4*l.length;for(let[e,t]of l.entries()){let n=h+w.length;u.writeUnsignedInt32(n),w.push(Buffer.from(`${t[1]}\0`,"utf16le")),f.get(r(t[0],g)).push([t[0],e])}let p=new e,I=new e,U=4+8*g;for(let e of(p.writeUnsignedInt32(g),f.values()))for(let[t,n]of(p.writeUnsignedInt32(e.length),p.writeUnsignedInt32(U+I.length),e))I.writeLengthPrefixedString(t,1),I.writeUnsignedInt32(n);let a=[];for(let[t,n]of d)"LBL1"===t?a.push(i(t,Buffer.concat([p.build(),I.build()]))):"TXT2"===t?a.push(function(t,n,r){let i=new e;return i.writeString("TXT2"),i.writeUnsignedInt32(4+n.length+r.length),i.pad(16),i.writeUnsignedInt32(t.length),i.push(n,r),i.pad(16,"«"),i.build()}(l,u.build(),w.build())):a.push(i(t,n));return function(t){let n=new e,r=32;for(let e of t)r+=e.length;return n.writeString("MsgStdBn"),n.writeUnsignedInt16(65279),n.writeUnsignedInt16(0),n.writeUnsignedInt8(1),n.writeUnsignedInt8(3),n.writeUnsignedInt16(t.length),n.writeUnsignedInt16(0),n.writeUnsignedInt32(r),n.write(10),n.push(...t),n.build()}(a)}