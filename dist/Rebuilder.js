import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import t from"iconv-lite";import{parseHeader as n}from"./parser/parseHeader.js";import{parseSections as r}from"./parser/parseSections.js";import{hash as i}from"./utils/hash.js";function o(t,n,r){let i=new e(r.bom);return i.writeString(t),i.writeUnsignedInt32(n.length),i.pad(16),i.push(n),i.pad(16,"«"),i.build()}export function rebuild(l,s){let d=n(s),f=r(s,d),g=0;for(let[e,t]of f.entries())"LBL1"===e&&(g=1===d.bom?t.readUInt32BE():t.readUInt32LE());let u=new Map(Array.from({length:g},(e,t)=>[t,[]])),w=new e(d.bom),h=new e(d.bom),p=4+4*l.length;for(let[e,n]of l.entries()){let r=p+h.length,o=1===d.bom?t.encode(n[1],"utf16be").toString("utf-16le"):n[1];w.writeUnsignedInt32(r),h.push(Buffer.from(`${o}\0`,"utf16le")),u.get(i(n[0],g)).push([n[0],e])}let m=new e(d.bom),b=new e(d.bom),I=4+8*g;for(let e of(m.writeUnsignedInt32(g),u.values()))for(let[t,n]of(m.writeUnsignedInt32(e.length),m.writeUnsignedInt32(I+b.length),e))b.writeLengthPrefixedString(t,1),b.writeUnsignedInt32(n);let U=[];for(let[t,n]of f)"LBL1"===t?U.push(o(t,Buffer.concat([m.build(),b.build()]),d)):"TXT2"===t?U.push(function(t,n,r,i){let o=new e(i.bom);return o.writeString("TXT2"),o.writeUnsignedInt32(4+n.length+r.length),o.pad(16),o.writeUnsignedInt32(t.length),o.push(n,r),o.pad(16,"«"),o.build()}(l,w.build(),h.build(),d)):U.push(o(t,n,d));let a=new e(d.bom),c=32;for(let e of U)c+=e.length;return a.writeString("MsgStdBn"),a.writeUnsignedInt16(65279),a.writeUnsignedInt16(0),a.writeUnsignedInt8(1),a.writeUnsignedInt8(3),a.writeUnsignedInt16(U.length),a.writeUnsignedInt16(0),a.writeUnsignedInt32(c),a.write(10),a.push(...U),a.build()}