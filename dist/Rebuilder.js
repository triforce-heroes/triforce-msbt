import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import{parseHeader as n}from"./parser/parseHeader.js";import{parseSections as t}from"./parser/parseSections.js";import{hash as r}from"./utils/hash.js";function i(n,t,r){let i=new e(r.bom);return i.writeString(n),i.writeUnsignedInt32(t.length),i.pad(16),i.push(t),i.pad(16,"«"),i.build()}export function rebuild(o,s){let l=n(s),d=t(s,l),g=0;for(let[e,n]of d.entries())"LBL1"===e&&(g=1===l.bom?n.readUInt32BE():n.readUInt32LE());let f=new Map(Array.from({length:g},(e,n)=>[n,[]])),u=new e(l.bom),w=new e(l.bom),h=4+4*o.length;for(let[e,n]of o.entries()){let t=h+w.length;u.writeUnsignedInt32(t),w.push(Buffer.from(n[1],"binary")),f.get(r(n[0],g)).push([n[0],e])}let p=new e(l.bom),m=new e(l.bom),a=4+8*g;for(let e of(p.writeUnsignedInt32(g),f.values()))for(let[n,t]of(p.writeUnsignedInt32(e.length),p.writeUnsignedInt32(a+m.length),e))m.writeLengthPrefixedString(n,1),m.writeUnsignedInt32(t);let b=[];for(let[n,t]of d)"LBL1"===n?b.push(i(n,Buffer.concat([p.build(),m.build()]),l)):"TXT2"===n?b.push(function(n,t,r,i){let o=new e(i.bom);return o.writeString("TXT2"),o.writeUnsignedInt32(4+t.length+r.length),o.pad(16),o.writeUnsignedInt32(n.length),o.push(t,r),o.pad(16,"«"),o.build()}(o,u.build(),w.build(),l)):b.push(i(n,t,l));let I=new e(l.bom),U=32;for(let e of b)U+=e.length;return I.writeString("MsgStdBn"),I.writeUnsignedInt16(65279),I.writeUnsignedInt16(0),I.writeUnsignedInt8(l.encoding),I.writeUnsignedInt8(3),I.writeUnsignedInt16(b.length),I.writeUnsignedInt16(0),I.writeUnsignedInt32(U),I.write(10),I.push(...b),I.build()}