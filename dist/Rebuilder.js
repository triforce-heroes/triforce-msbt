import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import{encodeFromString as n}from"@triforce-heroes/triforce-core/Encoding";import{parseHeader as t}from"./parser/parseHeader.js";import{parseSections as r}from"./parser/parseSections.js";import{hash as i}from"./utils/hash.js";function o(n,t,r){let i=new e(r.bom);return i.writeString(n),i.writeUnsignedInt32(t.length),i.pad(16),i.push(t),i.pad(16,"«"),i.build()}export function rebuild(s,d){let g=t(d),l=r(d,g),f=0;for(let[e,n]of l.entries())"LBL1"===e&&(f=1===g.bom?n.readUInt32BE():n.readUInt32LE());let u=new Map(Array.from({length:f},(e,n)=>[n,[]])),w=new e(g.bom),h=new e(g.bom),p=4+4*s.length,m=0===g.encoding;for(let[e,t]of s.entries()){let r=p+h.length;w.writeUnsignedInt32(r),h.push(m?n(`${t[1]}\0`):Buffer.from(`${t[1]}\0\0`,"binary")),u.get(i(t[0],f)).push([t[0],e])}let a=new e(g.bom),b=new e(g.bom),I=4+8*f;for(let e of(a.writeUnsignedInt32(f),u.values()))for(let[n,t]of(a.writeUnsignedInt32(e.length),a.writeUnsignedInt32(I+b.length),e))b.writeLengthPrefixedString(n,1),b.writeUnsignedInt32(t);let U=[];for(let[n,t]of l)"LBL1"===n?U.push(o(n,Buffer.concat([a.build(),b.build()]),g)):"TXT2"===n?U.push(function(n,t,r,i){let o=new e(i.bom);return o.writeString("TXT2"),o.writeUnsignedInt32(4+t.length+r.length),o.pad(16),o.writeUnsignedInt32(n.length),o.push(t,r),o.pad(16,"«"),o.build()}(s,w.build(),h.build(),g)):U.push(o(n,t,g));let c=new e(g.bom),B=32;for(let e of U)B+=e.length;return c.writeString("MsgStdBn"),c.writeUnsignedInt16(65279),c.writeUnsignedInt16(0),c.writeUnsignedInt8(g.encoding),c.writeUnsignedInt8(3),c.writeUnsignedInt16(U.length),c.writeUnsignedInt16(0),c.writeUnsignedInt32(B),c.write(10),c.push(...U),c.build()}