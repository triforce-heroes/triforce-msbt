import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import t from"iconv-lite";import{parseHeader as n}from"./parser/parseHeader.js";import{parseSections as r}from"./parser/parseSections.js";import{hash as i}from"./utils/hash.js";function o(t,n,r){let i=new e(r.bom);return i.writeString(t),i.writeUnsignedInt32(n.length),i.pad(16),i.push(n),i.pad(16,"«"),i.build()}export function rebuild(l,s){let d=n(s),g=r(s,d),f=0;for(let[e,t]of g.entries())"LBL1"===e&&(f=1===d.bom?t.readUInt32BE():t.readUInt32LE());let u=new Map(Array.from({length:f},(e,t)=>[t,[]])),w=new e(d.bom),h=new e(d.bom),p=4+4*l.length,m=0===d.encoding;for(let[e,n]of l.entries()){let r=p+h.length,o=1===d.bom?t.encode(n[1],"utf16be").toString("utf-16le"):n[1];w.writeUnsignedInt32(r),h.push(Buffer.from(o,m?"utf8":"utf16le")),u.get(i(n[0],f)).push([n[0],e])}let b=new e(d.bom),I=new e(d.bom),U=4+8*f;for(let e of(b.writeUnsignedInt32(f),u.values()))for(let[t,n]of(b.writeUnsignedInt32(e.length),b.writeUnsignedInt32(U+I.length),e))I.writeLengthPrefixedString(t,1),I.writeUnsignedInt32(n);let a=[];for(let[t,n]of g)"LBL1"===t?a.push(o(t,Buffer.concat([b.build(),I.build()]),d)):"TXT2"===t?a.push(function(t,n,r,i){let o=new e(i.bom);return o.writeString("TXT2"),o.writeUnsignedInt32(4+n.length+r.length),o.pad(16),o.writeUnsignedInt32(t.length),o.push(n,r),o.pad(16,"«"),o.build()}(l,w.build(),h.build(),d)):a.push(o(t,n,d));let c=new e(d.bom),B=32;for(let e of a)B+=e.length;return c.writeString("MsgStdBn"),c.writeUnsignedInt16(65279),c.writeUnsignedInt16(0),c.writeUnsignedInt8(d.encoding),c.writeUnsignedInt8(3),c.writeUnsignedInt16(a.length),c.writeUnsignedInt16(0),c.writeUnsignedInt32(B),c.write(10),c.push(...a),c.build()}