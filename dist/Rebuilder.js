import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import{parseHeader as n}from"./parser/parseHeader.js";import{parseSections as t}from"./parser/parseSections.js";import{hash as r}from"./utils/hash.js";function i(n,t,r){let i=new e(r.bom);return i.writeString(n),i.writeUnsignedInt32(t.length),i.pad(16),i.push(t),i.pad(16,"«"),i.build()}export function rebuild(o,s){let l=n(s),d=t(s,l),g=0;for(let[e,n]of d.entries())"LBL1"===e&&(g=1===l.bom?n.readUInt32BE():n.readUInt32LE());let f=new Map(Array.from({length:g},(e,n)=>[n,[]])),u=new e(l.bom),w=new e(l.bom),h=4+4*o.length,p=0===l.encoding?"\0":"\0\0";for(let[e,n]of o.entries()){let t=h+w.length;u.writeUnsignedInt32(t),w.push(Buffer.from(n[1]+p,"binary")),f.get(r(n[0],g)).push([n[0],e])}let m=new e(l.bom),a=new e(l.bom),b=4+8*g;for(let e of(m.writeUnsignedInt32(g),f.values()))for(let[n,t]of(m.writeUnsignedInt32(e.length),m.writeUnsignedInt32(b+a.length),e))a.writeLengthPrefixedString(n,1),a.writeUnsignedInt32(t);let I=[];for(let[n,t]of d)"LBL1"===n?I.push(i(n,Buffer.concat([m.build(),a.build()]),l)):"TXT2"===n?I.push(function(n,t,r,i){let o=new e(i.bom);return o.writeString("TXT2"),o.writeUnsignedInt32(4+t.length+r.length),o.pad(16),o.writeUnsignedInt32(n.length),o.push(t,r),o.pad(16,"«"),o.build()}(o,u.build(),w.build(),l)):I.push(i(n,t,l));let U=new e(l.bom),c=32;for(let e of I)c+=e.length;return U.writeString("MsgStdBn"),U.writeUnsignedInt16(65279),U.writeUnsignedInt16(0),U.writeUnsignedInt8(l.encoding),U.writeUnsignedInt8(3),U.writeUnsignedInt16(I.length),U.writeUnsignedInt16(0),U.writeUnsignedInt32(c),U.write(10),U.push(...I),U.build()}